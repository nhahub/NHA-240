@model Estately.Services.ViewModels.PropertyViewModel

@{
    ViewData["Title"] = "Edit Property";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .image-preview-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .img-preview-card {
        position: relative;
        width: 120px;
        height: 90px;
        border: 1px solid #e1e1e1;
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
    }

    .preview-thumb {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
    }

    .img-remove-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        line-height: 18px;
        cursor: pointer;
    }
</style>

<div class="table-container">
    <h4>Edit Property</h4>

    <form asp-action="Edit" method="post" enctype="multipart/form-data" class="mt-4">
        <input type="hidden" asp-for="PropertyID" />
        <input type="hidden" asp-for="PropertyCode" />

        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <label class="form-label">Address <span class="text-danger">*</span></label>
                    <input asp-for="Address" class="form-control" />
                    <span asp-validation-for="Address" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Price</label>
                        <input asp-for="Price" class="form-control" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Area (m²)</label>
                        <input asp-for="Area" class="form-control" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Year Built</label>
                        <input asp-for="YearBuilt" class="form-control" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Beds No.</label>
                        <input asp-for="BedsNo" class="form-control" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Baths No.</label>
                        <input asp-for="BathsNo" class="form-control" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Floor No.</label>
                        <input asp-for="FloorNo" class="form-control" />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Property Type</label>
                        <select asp-for="PropertyTypeID" class="form-control" asp-items="@(new SelectList(Model.PropertyTypes, "PropertyTypeID", "TypeName"))"></select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Status</label>
                        <select asp-for="StatusId" class="form-control" asp-items="@(new SelectList(Model.Statuses, "StatusID", "StatusName"))"></select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Zone</label>
                        <select asp-for="ZoneID" class="form-control" asp-items="@(new SelectList(Model.Zones, "ZoneId", "ZoneName"))"></select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Agent</label>
                    <select asp-for="AgentId" class="form-control" asp-items="@(new SelectList(Model.Agents, "EmployeeID", "FullName"))">
                        <option value="">-- Select --</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Developer</label>
                    <select asp-for="DeveloperProfileID" class="form-control" asp-items="@(new SelectList(Model.Developers, "DeveloperProfileID", "DeveloperTitle"))">
                        <option value="">-- Select --</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Features</label>
                    <div>
                        @foreach (var f in Model.AllFeatures)
                        {
                            <div class="form-check form-check-inline">
                                <input class="form-check-input"
                                       type="checkbox"
                                       name="SelectedFeatures"
                                       value="@f.FeatureID"
                                       id="feat-@f.FeatureID"
                                       @(Model.SelectedFeatures != null && Model.SelectedFeatures.Contains(f.FeatureID) ? "checked" : "") />

                                <label class="form-check-label" for="feat-@f.FeatureID">
                                    @f.FeatureName
                                </label>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Latitude</label>
                    <input asp-for="Latitude" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Longitude</label>
                    <input asp-for="Longitude" class="form-control" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Upload New Images</label>
                    <input type="file" id="fileInput" name="UploadedFiles" multiple class="form-control" accept="image/*" />
                    <p class="form-text text-muted">You can select multiple images. Existing images are shown below.</p>
                    <span asp-validation-for="UploadedFiles" class="text-danger"></span>
                </div>

                <h6>Existing Images</h6>
                <div id="existingImages" class="image-preview-grid mb-3">
                    @if (Model.Images != null && Model.Images.Count > 0)
                    {
                        foreach (var img in Model.Images)
                        {
                            <div class="img-preview-card" data-image-id="@img.ImageID">
                                <img src="~/@img.ImagePath" class="preview-thumb" />
                                <button type="button" class="img-remove-btn existing-remove" title="Remove image" data-image-id="@img.ImageID">&times;</button>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-muted">No images uploaded.</div>
                    }
                </div>

                <div id="ImagesToDeleteContainer"></div>

                <div id="newPreviews" class="image-preview-grid mb-3"></div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-admin">
                        <i class="bi bi-save me-2"></i>Save Changes
                    </button>
                    <a asp-action="Index" class="btn btn-secondary ms-2">
                        <i class="bi bi-arrow-left-circle me-2"></i>Back to List
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        (function () {
            // existing images removal: collect IDs so backend can delete them
            const imagesToDelete = new Set();
            const deleteContainer = document.getElementById('ImagesToDeleteContainer');

            document.querySelectorAll('.existing-remove').forEach(btn => {
                btn.addEventListener('click', function () {
                    const id = this.getAttribute('data-image-id');
                    if (!id) return;
                    imagesToDelete.add(id);
                    // remove parent card
                    const card = this.closest('.img-preview-card');
                    if (card) card.remove();
                    updateField();
                });
            });

            function updateField() {
                // clear previous hidden inputs
                deleteContainer.innerHTML = '';
                // create one hidden input per image id => binds to List<int> ImagesToDelete
                imagesToDelete.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'ImagesToDelete';
                    input.value = id;
                    deleteContainer.appendChild(input);
                });
            }

            // New files preview logic (similar to Create)
            const input = document.getElementById('fileInput');
            const newPreviews = document.getElementById('newPreviews');

            input.addEventListener('change', function (e) {
                newPreviews.innerHTML = '';
                const files = Array.from(input.files || []);
                files.forEach((file, idx) => {
                    if (!file.type.startsWith('image/')) return;
                    const reader = new FileReader();
                    const wrapper = document.createElement('div');
                    wrapper.className = 'img-preview-card';
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'img-remove-btn';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.title = 'Remove';
                    removeBtn.addEventListener('click', function () {
                        const dt = new DataTransfer();
                        const current = Array.from(input.files);
                        current.forEach((f, i) => { if (i !== idx) dt.items.add(f); });
                        input.files = dt.files;
                        wrapper.remove();
                        input.dispatchEvent(new Event('change'));
                    });

                    const img = document.createElement('img');
                    img.className = 'preview-thumb';

                    reader.onload = function (ev) {
                        img.src = ev.target.result;
                    };

                    wrapper.appendChild(img);
                    wrapper.appendChild(removeBtn);
                    newPreviews.appendChild(wrapper);
                    reader.readAsDataURL(file);
                });
            });
        })();
    </script>
}